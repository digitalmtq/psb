<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lembar Penilaian – Page + Surah/Ayat Sinkron</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --brand:#2563eb;
      --soft:#e5e7eb;
      --ring:#93c5fd;
      --success:#16a34a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
      background:linear-gradient(180deg,#fafbff, #f2f4fb 40%, #eef1f9);
    }

    .container{
      height:100vh;
      display:grid;
      grid-template-columns: minmax(320px, 420px) 1fr;
      grid-template-areas: "form mushaf";
      gap:12px; padding:12px;
    }
    #formPanel{grid-area:form}
    #mushafPanel{grid-area:mushaf}

    .panel{
      background:var(--card); border:1px solid var(--soft); border-radius:14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      overflow:auto;
    }
    .panel .inner{padding:16px}
    .section{margin-bottom:16px}
    .section h3{margin:0 0 8px; font-size:14px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted)}
    label{display:block; font-size:13px; margin-bottom:8px}
    input[type="text"], input[type="date"], input[type="number"], select, textarea{
      width:100%; padding:10px 12px; border:1px solid var(--soft); border-radius:10px; font:inherit; background:#fff;
    }
    textarea{min-height:90px; resize:vertical}

    .grid-2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .rubric-row{display:grid; grid-template-columns: 140px 1fr 52px; gap:10px; align-items:center; padding:8px 0; border-bottom:1px dashed #eceff5}
    .rubric-row:last-child{border-bottom:none}
    .rubric-name{font-size:14px}
    .rubric-score output{display:inline-block; min-width:40px; text-align:right; font-variant-numeric: tabular-nums}
    input[type="range"]{width:100%}

    .summary{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:center; padding:12px; border:1px solid var(--soft); border-radius:12px; background:#fafafa;
    }
    .summary .big{font-size:28px; font-weight:700}
    .badge{display:inline-block; padding:4px 10px; border-radius:999px; background:#eef6ff; color:#0b63d1; font-weight:600}

    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid var(--soft); background:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font:inherit}
    .btn.primary{background:var(--brand); border-color:var(--brand); color:#fff}
    .btn.ghost{background:transparent}
    .btn:focus{outline:3px solid var(--ring); outline-offset:2px}

    /* Right panel (Mushaf) */
    .mushaf-header{
      position:sticky; top:0; z-index:5; background:var(--card);
      border-bottom:1px solid var(--soft); padding:10px 12px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap
    }
    .mushaf-area{padding:18px; line-height:2.1; font-size:26px; direction:rtl; text-align:justify; font-family: "Traditional Arabic", "Amiri", serif}
    .ayah{padding:2px 6px; border-radius:6px; display:inline}
    .muted{color:var(--muted)}

    @media (max-width: 920px){
      .container{
        grid-template-columns: 1fr;
        grid-template-areas:
          "mushaf"
          "form";
      }
      .mushaf-area{font-size:24px}
    }
  </style>
</head>
<body>
  <!-- Header dihapus total -->

  <main class="container">
    <!-- KIRI: FORM PENILAIAN -->
    <section class="panel" id="formPanel" aria-label="Form Penilaian">
      <div class="inner">
        <!-- Identitas -->
        <div class="section">
          <h3>Identitas</h3>
          <div class="grid-2">
            <label>Nama Santri
              <input type="text" id="namaSantri" placeholder="Contoh: Ahmad Zaki" />
            </label>
            <label>NIS
              <input type="text" id="nisSantri" placeholder="Contoh: 552233" />
            </label>
          </div>
          <div class="grid-2">
            <label>Kelas / Halaqah
              <input type="text" id="kelasSantri" placeholder="Contoh: Kelas 3 – Halaqah Ust. Budi" />
            </label>
            <label>Tanggal
              <input type="date" id="tanggal" />
            </label>
          </div>
          <label>Penguji
            <input type="text" id="penguji" placeholder="Nama Ustadz/Ustadzah" />
          </label>
        </div>

        <!-- Aspek Penilaian -->
        <div class="section">
          <h3>Aspek Penilaian</h3>
          <div class="rubric-row">
            <div class="rubric-name">Tajwid <span class="muted">(30%)</span></div>
            <div class="rubric-score"><input type="range" id="rTajwid" min="0" max="100" step="1" value="80" /></div>
            <div><output id="oTajwid">80</output></div>
          </div>
          <div class="rubric-row">
            <div class="rubric-name">Makharijul Huruf <span class="muted">(25%)</span></div>
            <div class="rubric-score"><input type="range" id="rMakharij" min="0" max="100" step="1" value="80" /></div>
            <div><output id="oMakharij">80</output></div>
          </div>
          <div class="rubric-row">
            <div class="rubric-name">Kelancaran <span class="muted">(25%)</span></div>
            <div class="rubric-score"><input type="range" id="rLancar" min="0" max="100" step="1" value="80" /></div>
            <div><output id="oLancar">80</output></div>
          </div>
          <div class="rubric-row">
            <div class="rubric-name">Tartil/Irama <span class="muted">(15%)</span></div>
            <div class="rubric-score"><input type="range" id="rTartil" min="0" max="100" step="1" value="80" /></div>
            <div><output id="oTartil">80</output></div>
          </div>
          <div class="rubric-row">
            <div class="rubric-name">Adab/Sikap <span class="muted">(5%)</span></div>
            <div class="rubric-score"><input type="range" id="rAdab" min="0" max="100" step="1" value="80" /></div>
            <div><output id="oAdab">80</output></div>
          </div>
        </div>

        <!-- Catatan -->
        <div class="section">
          <h3>Catatan</h3>
          <textarea id="catatan" placeholder="Catatan penguji… (lafaz perlu ditekan, mad iwad, idgham, dsb.)"></textarea>
        </div>

        <!-- Ringkasan & Aksi -->
        <div class="section">
          <div class="summary" id="summaryBox" aria-live="polite">
            <div>
              <div class="muted">Nilai Akhir</div>
              <div class="big" id="nilaiAkhir">80.0</div>
            </div>
            <div>
              <div class="muted">Predikat</div>
              <div class="badge" id="predikat">B</div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnSimpan" type="button">Simpan</button>
          <button class="btn" id="btnUnduhPdf" type="button">Unduh PDF (Coming Soon)</button>
          <button class="btn ghost" id="btnReset" type="button">Reset</button>
        </div>
      </div>
    </section>

    <!-- KANAN: HALAMAN AL-QUR'AN -->
    <section class="panel" id="mushafPanel" aria-label="Halaman Mushaf">
      <div class="mushaf-header">
        <label style="display:flex; align-items:center; gap:6px; font-size:13px">Page
          <select id="pageSelect"></select>
        </label>

        <label style="display:flex; align-items:center; gap:6px; font-size:13px">Surah dari
          <select id="surahFrom"></select>
        </label>
        <label style="display:flex; align-items:center; gap:6px; font-size:13px">Ayat
          <select id="ayahFrom"></select>
        </label>
        <span class="muted" aria-hidden="true">→</span>
        <label style="display:flex; align-items:center; gap:6px; font-size:13px">ke Surah
          <select id="surahTo"></select>
        </label>
        <label style="display:flex; align-items:center; gap:6px; font-size:13px">Ayat
          <select id="ayahTo"></select>
        </label>

        <span style="flex:1"></span>
        <label style="display:flex; align-items:center; gap:6px; font-size:13px">Ukuran teks
          <input type="range" id="fontScale" min="20" max="40" value="26" />
        </label>
      </div>

      <div class="mushaf-area" id="mushafArea">
        <!-- konten ayat dirender via JS -->
      </div>
    </section>
  </main>

  <script>
    // ====== Konfigurasi rubrik (bobot) ======
    const BOBOT = { tajwid: 0.30, makharij: 0.25, lancar: 0.25, tartil: 0.15, adab: 0.05 };

    // ====== Util ======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
    const cmpPair = (p, q) => (p.surah - q.surah) || (p.ayat - q.ayat);

    // ====== Binding input → output angka ======
    function bindRange(idRange, idOut){
      const el = $("#"+idRange); const out = $("#"+idOut);
      if(!el||!out) return;
      const fn = ()=>{ out.value = Number(el.value).toFixed(0); hitungNilaiAkhir(); };
      el.addEventListener('input', fn); fn();
    }
    bindRange('rTajwid','oTajwid');
    bindRange('rMakharij','oMakharij');
    bindRange('rLancar','oLancar');
    bindRange('rTartil','oTartil');
    bindRange('rAdab','oAdab');

    // ====== Hitung nilai akhir ======
    function hitungNilaiAkhir(){
      const v = {
        tajwid: +$('#rTajwid').value || 0,
        makharij: +$('#rMakharij').value || 0,
        lancar: +$('#rLancar').value || 0,
        tartil: +$('#rTartil').value || 0,
        adab: +$('#rAdab').value || 0,
      };
      const total = v.tajwid*BOBOT.tajwid + v.makharij*BOBOT.makharij + v.lancar*BOBOT.lancar + v.tartil*BOBOT.tartil + v.adab*BOBOT.adab;
      $('#nilaiAkhir').textContent = total.toFixed(1);
      $('#predikat').textContent = predikat(total);
      $('#summaryBox').style.borderColor = total >= 85 ? '#bbf7d0' : '#fde68a';
      $('#summaryBox').style.background = total >= 85 ? '#f0fdf4' : '#fffbeb';
    }
    function predikat(n){
      if(n>=90) return 'A';
      if(n>=85) return 'A-';
      if(n>=80) return 'B+';
      if(n>=75) return 'B';
      if(n>=70) return 'B-';
      if(n>=65) return 'C+';
      if(n>=60) return 'C';
      return 'D';
    }

    // ====== Mushaf controls ======
    const fontSlider = $('#fontScale');
    const mushafArea = $('#mushafArea');

    // --- Nama Surah (1..114) ---
    const SURAH_NAMES = [
      "Al-Fatihah","Al-Baqarah","Ali 'Imran","An-Nisa'","Al-Ma'idah","Al-An'am","Al-A'raf","Al-Anfal","At-Taubah","Yunus",
      "Hud","Yusuf","Ar-Ra'd","Ibrahim","Al-Hijr","An-Nahl","Al-Isra'","Al-Kahf","Maryam","Ta Ha",
      "Al-Anbiya'","Al-Hajj","Al-Mu'minun","An-Nur","Al-Furqan","Ash-Shu'ara'","An-Naml","Al-Qasas","Al-'Ankabut","Ar-Rum",
      "Luqman","As-Sajdah","Al-Ahzab","Saba'","Fatir","Ya-Sin","As-Saffat","Sad","Az-Zumar","Ghafir",
      "Fussilat","Ash-Shura","Az-Zukhruf","Ad-Dukhan","Al-Jathiyah","Al-Ahqaf","Muhammad","Al-Fath","Al-Hujurat","Qaf",
      "Adz-Dzariyat","At-Tur","An-Najm","Al-Qamar","Ar-Rahman","Al-Waqi'ah","Al-Hadid","Al-Mujadilah","Al-Hashr","Al-Mumtahanah",
      "As-Saff","Al-Jumu'ah","Al-Munafiqun","At-Taghabun","At-Talaq","At-Tahrim","Al-Mulk","Al-Qalam","Al-Haqqah","Al-Ma'arij",
      "Nuh","Al-Jinn","Al-Muzzammil","Al-Muddaththir","Al-Qiyamah","Al-Insan","Al-Mursalat","An-Naba'","An-Nazi'at","'Abasa",
      "At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Inshiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Ghashiyah","Al-Fajr","Al-Balad",
      "Ash-Shams","Al-Layl","Ad-Duha","Ash-Sharh","At-Tin","Al-'Alaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-'Adiyat",
      "Al-Qari'ah","At-Takathur","Al-'Asr","Al-Humazah","Al-Fil","Quraysh","Al-Ma'un","Al-Kawthar","Al-Kafirun","An-Nasr",
      "Al-Masad","Al-Ikhlas","Al-Falaq","An-Nas"
    ];

    // Sumber data
    const SOURCES = {
      quran: 'https://raw.githubusercontent.com/dickymiswardi/mtq/refs/heads/main/symbol1.json',
      pageMap: 'https://raw.githubusercontent.com/dickymiswardi/tadabbur/refs/heads/main/ayah_page_map.json'
    };

    let quranData = {};          // "s:a" → teks (dengan '|' jadi spasi)
    let ayahPageMap = {};        // "s:a" → nomor halaman (1..604)
    const surahMaxAyah = {};     // s → jumlah ayat per surah
    const fontLoadedPages = new Set();
    const pageIndex = {};        // page → [{surah, ayat}] (urut)

    // ====== Helper dropdown ======
    function makeOpts(n){ return Array.from({length:n}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join(''); }

    function fillSurahSelect(sel){
      const el=$(sel);
      el.innerHTML = Array.from({length:114}, (_,i)=>{
        const no = i+1;
        const name = SURAH_NAMES[i] || `Surah ${no}`;
        return `<option value="${no}">${no} — ${name}</option>`;
      }).join('');
    }

    function fillAyahSelect(sel, max){ const el=$(sel); el.innerHTML = makeOpts(max); }

    function fillPageSelect(){
      const el = $('#pageSelect');
      el.innerHTML = makeOpts(604); // 1..604
    }

    // ====== Data prep ======
    function computeSurahMax(){
      for(const key of Object.keys(quranData||{})){
        const [s,a] = key.split(':').map(Number);
        if(!s || !a) continue;
        if(!surahMaxAyah[s] || a>surahMaxAyah[s]) surahMaxAyah[s]=a;
      }
      for(let s=1;s<=114;s++){ if(!surahMaxAyah[s]) surahMaxAyah[s]=300; } // fallback
    }

    function buildPageIndex(){
      // Buat indeks halaman → pasangan (surah, ayat) terurut
      for(const [key, page] of Object.entries(ayahPageMap)){
        const [s,a] = key.split(':').map(Number);
        if(!s || !a || !page) continue;
        (pageIndex[page] ||= []).push({surah:s, ayat:a});
      }
      for(const p of Object.keys(pageIndex)){
        pageIndex[p].sort(cmpPair);
      }
    }

    async function loadQuran(){
      try{
        const [q, p] = await Promise.all([
          fetch(SOURCES.quran).then(r=>r.json()),
          fetch(SOURCES.pageMap).then(r=>r.json())
        ]);
        quranData = q; ayahPageMap = p;
        computeSurahMax();
        buildPageIndex();

        // isi dropdown awal
        fillPageSelect();
        fillSurahSelect('#surahFrom'); fillSurahSelect('#surahTo');
        fillAyahSelect('#ayahFrom', surahMaxAyah[1]||7);
        fillAyahSelect('#ayahTo',   surahMaxAyah[1]||7);

        // default: Page 1
        $('#pageSelect').value = '1';
        applyPageSelection(1); // ini juga set Surah/Ayat dari & ke
      }catch(err){
        mushafArea.innerHTML = `<div class="muted">Gagal memuat data Qur'an. Periksa koneksi atau sumber data.</div>`;
        console.error(err);
      }
    }

    // ====== Rendering ======
    async function ensurePageFont(page){
      if(fontLoadedPages.has(page)) return;
      const pageStr = String(page).padStart(3,'0');
      const fontUrl = `https://raw.githubusercontent.com/dickymiswardi/quran/refs/heads/main/fonts/QCF_P${pageStr}.TTF`;
      try{
        const font = new FontFace(`QCF_P${pageStr}`, `url(${fontUrl})`);
        await font.load(); document.fonts.add(font); fontLoadedPages.add(page);
      }catch(err){ console.warn('Gagal load font page', page, err); }
    }

    async function renderMushafRange(){
      const sF = +$('#surahFrom').value || 1;
      const aF = +$('#ayahFrom').value || 1;
      const sT = +$('#surahTo').value || sF;
      const aT = +$('#ayahTo').value || aF;

      // Kumpulkan ayat per halaman
      const halamanMap = {};
      for(let s=sF; s<=sT; s++){
        const aStart = (s===sF) ? aF : 1;
        const aEnd   = (s===sT) ? aT : (surahMaxAyah[s]||300);
        for(let a=aStart; a<=aEnd; a++){
          const key = `${s}:${a}`;
          const teks = quranData[key];
          const page = ayahPageMap[key];
          if(!teks || !page) continue;
          (halamanMap[page] ||= []).push({surah:s, ayat:a, teks:String(teks).replace(/\|/g,' ')});
        }
      }

      mushafArea.innerHTML = '';
      const pages = Object.keys(halamanMap).map(Number).sort((x,y)=>x-y);
      for(const page of pages){
        await ensurePageFont(page);
        const pageStr = String(page).padStart(3,'0');
        const pageDiv = document.createElement('div');
        pageDiv.style.fontFamily = `QCF_P${pageStr}, serif`;
        pageDiv.style.fontSize   = (parseInt(fontSlider?.value||'26',10))+'px';
        pageDiv.style.lineHeight = '2.2';
        pageDiv.style.direction  = 'rtl';
        pageDiv.style.marginBottom = '20px';

        halamanMap[page].forEach(item=>{
          const span = document.createElement('span');
          span.className = 'ayah';
          span.dataset.ayah = String(item.ayat);
          span.textContent = item.teks; // tanpa penomoran
          pageDiv.appendChild(span);
          pageDiv.appendChild(document.createTextNode(' '));
        });
        mushafArea.appendChild(pageDiv);
      }

      // Sinkronkan pageSelect bila range hanya 1 halaman
      if(pages.length === 1){
        $('#pageSelect').value = String(pages[0]);
      }

      if(!pages.length){
        mushafArea.innerHTML = `<div class="muted">Tidak ada ayat pada rentang yang dipilih.</div>`;
      }
    }

    function setRange(sFrom, aFrom, sTo, aTo){
      // Sesuaikan pilihan dan isi opsi ayat berdasarkan surah
      $('#surahFrom').value = String(sFrom);
      fillAyahSelect('#ayahFrom', surahMaxAyah[sFrom] || aFrom);
      $('#ayahFrom').value = String(aFrom);

      $('#surahTo').value = String(sTo);
      fillAyahSelect('#ayahTo', surahMaxAyah[sTo] || aTo);
      $('#ayahTo').value = String(aTo);
    }

    function applyPageSelection(page){
      const arr = pageIndex[page] || [];
      if(!arr.length){
        mushafArea.innerHTML = `<div class="muted">Halaman ${page} tidak memiliki data.</div>`;
        return;
      }
      const first = arr[0];
      const last  = arr[arr.length - 1];
      setRange(first.surah, first.ayat, last.surah, last.ayat);
      renderMushafRange();
    }

    function guardRange(){
      const sF=+$('#surahFrom').value, aF=+$('#ayahFrom').value;
      let sT=+$('#surahTo').value,   aT=+$('#ayahTo').value;
      if(sT<sF || (sT===sF && aT<aF)){
        $('#surahTo').value=String(sF);
        fillAyahSelect('#ayahTo', surahMaxAyah[sF]||aF);
        $('#ayahTo').value=String(aF);
      }
    }

    function onChangeSurah(which){
      const s = +(which==='from' ? $('#surahFrom').value : $('#surahTo').value) || 1;
      const max = surahMaxAyah[s] || 300;
      fillAyahSelect(which==='from' ? '#ayahFrom' : '#ayahTo', max);
      if(which==='to') $('#ayahTo').value = String(max);
      guardRange(); renderMushafRange();
    }

    // ====== Bindings ======
    fontSlider?.addEventListener('input', ()=>{ renderMushafRange(); });

    $('#surahFrom').addEventListener('change', ()=>onChangeSurah('from'));
    $('#surahTo').addEventListener('change', ()=>onChangeSurah('to'));
    $('#ayahFrom').addEventListener('change', ()=>{ guardRange(); renderMushafRange(); });
    $('#ayahTo').addEventListener('change', ()=>{ guardRange(); renderMushafRange(); });

    $('#pageSelect').addEventListener('change', ()=>{
      const p = +$('#pageSelect').value || 1;
      applyPageSelection(p);
    });

    // start
    loadQuran();

    // ====== Aksi tombol ======
    $('#btnReset').addEventListener('click', ()=>{
      document.querySelector('#formPanel form')?.reset?.();
      ['rTajwid','rMakharij','rLancar','rTartil','rAdab'].forEach(id=>{ const el=$('#'+id); if(el){ el.value=80; el.dispatchEvent(new Event('input')); }});
      $('#catatan').value='';

      // reset ke Page 1
      $('#pageSelect').value='1';
      applyPageSelection(1);
    });

    $('#btnSimpan').addEventListener('click', ()=>{
      const data = {
        identitas: {
          nama: $('#namaSantri').value.trim(),
          nis: $('#nisSantri').value.trim(),
          kelas: $('#kelasSantri').value.trim(),
          tanggal: $('#tanggal').value,
          penguji: $('#penguji').value.trim(),
        },
        bacaan: {
          page: +$('#pageSelect').value || null,
          surahDari: +$('#surahFrom').value || 1,
          ayatDari: +$('#ayahFrom').value || 1,
          surahSampai: +$('#surahTo').value || (+$('#surahFrom').value || 1),
          ayatSampai: +$('#ayahTo').value || (+$('#ayahFrom').value || 1),
        },
        nilai: {
          tajwid: +$('#rTajwid').value || 0,
          makharij: +$('#rMakharij').value || 0,
          lancar: +$('#rLancar').value || 0,
          tartil: +$('#rTartil').value || 0,
          adab: +$('#rAdab').value || 0,
          akhir: +$('#nilaiAkhir').textContent || 0,
          predikat: $('#predikat').textContent,
        },
        catatan: $('#catatan').value.trim(),
        dibuat: new Date().toISOString(),
      };
      console.log('[KERANGKA] Data penilaian:', data);
      const btn = $('#btnSimpan');
      btn.disabled = true; btn.textContent = 'Tersimpan (dummy)…';
      setTimeout(()=>{ btn.disabled=false; btn.textContent='Simpan'; }, 1000);
    });

    $('#btnUnduhPdf').addEventListener('click', ()=>{
      alert('Fitur PDF belum diaktifkan pada kerangka ini. Nanti bisa dihubungkan ke jsPDF atau server.');
    });
  </script>
</body>
</html>
